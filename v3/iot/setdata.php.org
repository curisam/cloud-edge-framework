<?php
    //------------------------------------------------------------------------------------------
    // File : opendb.php
    // Last : 2019.03.20
    // By   : Jongbin Park @ KETI
    // 
	// Example in you internet browser 
    // http://ketihhc.iptime.org/iot/setdata.php?sn=FFFF0001&json_str="{data:{Temperature:23.12,Humidity:42.13,Gyro:[11.23,22.32,345.23],Magnetic:[51.23,52.32,545.23]},user:KETI,status:online}"
    //------------------------------------------------------------------------------------------
      

    //------------------------------------------------------------------------------------------
    // <code/>
    //------------------------------------------------------------------------------------------

	if($_SERVER["REQUEST_METHOD"] == "GET") {   // GET
		$sn= $_GET["sn"];
		$json_str = $_GET["json_str"];

		//printf($sn);
		//printf("</br>");
		//printf($json_str);
	}
	else if($_SERVER["REQUEST_METHOD"] == "POST") { // POST
		//$myusername = mysqli_real_escape_string($conn,$_POST['username']);
		//$mypassword = mysqli_real_escape_string($conn,$_POST['password']); 
		
		// GET
		//$sn= $_GET["sn"];
		//$json_str = $_POST['json_str'];
		//$json_str = json_encode(json_decode($json_str));
	}
	

    // Main code
	{
		include("opendb.php");
		mysqli_select_db($conn, 'seciotdb') or die('Could not select database');
		
		// Update
		$sql = "UPDATE sensors SET sensor_realtime_data='". $json_str ."' WHERE sensor_sn='". $sn ."' ";
		
		$result = mysqli_query($conn, $sql) or die('Query failed: ' . mysqli_error());
		
		// Insert
		$sql = "INSERT INTO sensor_log (sensor_sn, sensor_data_json) VALUES ('".$sn."', '".$json_str."')";
		$result = mysqli_query($conn, $sql) or die('Query failed: ' . mysqli_error());
		include("closedb.php");
	}

	echo json_encode(json_decode($json_str));

    //------------------------------------------------------------------------------------------
    // </code>
    //------------------------------------------------------------------------------------------
?>

